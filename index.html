<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸“ä¸šä»»åŠ¡ç®¡ç†ç³»ç»Ÿ - Multi-Page</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* --- ğŸ¨ CSS æ ·å¼ï¼šä¸“ä¸šåŒ–å¤šé¡µé¢é‡æ„ --- */
        :root {
            --primary-color: #1abc9c; /* å“ç‰Œè‰² - ç°ä»£é’ç»¿è‰² (é»˜è®¤ä¸»é¢˜) */
            --primary-dark: #16a085;
            --secondary-color: #e74c3c; /* çº¢è‰² */
            --success-color: #2ecc71; /* ç»¿è‰² */
            --bg-color: #ecf0f1; /* æµ…ç°èƒŒæ™¯ */
            --sidebar-color: #34495e; /* æ·±è“è‰²ä¾§è¾¹æ  */
            --card-color: #ffffff;
            --text-color: #2c3e50; /* æ·±è‰²æ–‡æœ¬ */
            --shadow-elevation: 0 4px 12px rgba(0, 0, 0, 0.1);
            
            /* ä¼˜å…ˆçº§é¢œè‰² */
            --prio-high: #e74c3c;
            --prio-medium: #f39c12;
            --prio-low: #2ecc71;
        }

        body {
            font-family: 'Roboto', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            color: var(--text-color);
            overflow: hidden; 
        }

        /* 1. å¼€å¹•å’Œç™»å½•ç•Œé¢ */
        #splashScreen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: var(--primary-color); display: flex; flex-direction: column;
            justify-content: center; align-items: center; color: white;
            z-index: 1000; opacity: 1; transition: opacity 1s ease-out; font-size: 2em;
        }
        .splash-text { animation: fadeIn 2s ease-in-out forwards; font-weight: 300; text-align: center; }
        .splash-text strong { font-weight: 700; display: block; font-size: 3em; margin-bottom: 10px; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        #authScreen {
            position: fixed; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.8);
            z-index: 999; display: none; justify-content: center; align-items: center;
            opacity: 1; transition: opacity 0.5s;
        }

        .auth-box {
            background: linear-gradient(145deg, var(--card-color), #f9f9f9);
            padding: 40px; border-radius: 15px; width: 350px; text-align: center;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.4);
        }
        .auth-box h2 { color: var(--primary-dark); margin-bottom: 25px; font-weight: 500; }
        .auth-box input {
            width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #ddd;
            border-radius: 6px; box-sizing: border-box;
        }
        .auth-box button {
            width: 100%; padding: 12px; border: none; border-radius: 6px; cursor: pointer;
            margin-bottom: 10px; transition: background-color 0.3s;
        }
        #loginBtn { background-color: var(--primary-color); color: white; }
        #registerBtn { background-color: #6c757d; color: white; }
        #loginBtn:hover { background-color: var(--primary-dark); }


        /* 2. ä¸»åº”ç”¨å¸ƒå±€ (Side-Bar Layout) */
        .app-container {
            display: none; width: 90%; max-width: 1200px; height: 85vh;
            background: var(--card-color); border-radius: 15px;
            box-shadow: var(--shadow-elevation); overflow: hidden;
            grid-template-columns: 250px 1fr;
        }
        body.logged-in .app-container { display: grid; }
        body.logged-in { overflow: auto; align-items: center; }

        /* 2.1 å·¦ä¾§å¯¼èˆªæ  */
        .sidebar {
            background-color: var(--sidebar-color); color: white; padding: 20px 0;
            display: flex; flex-direction: column; justify-content: space-between;
        }
        .sidebar h2 { text-align: center; margin: 0 0 30px 0; font-size: 1.5em; color: #ecf0f1; }
        .nav-link {
            padding: 15px 20px; display: flex; align-items: center; cursor: pointer;
            transition: background-color 0.2s, color 0.2s;
        }
        .nav-link:hover, .nav-link.active { background-color: var(--primary-color); color: white; }
        .nav-link i { margin-right: 15px; font-size: 1.2em; }
        .username-display { font-weight: 500; color: #ecf0f1; padding: 10px; }
        #logoutBtn {
            background-color: var(--secondary-color); color: white; padding: 8px 15px;
            border-radius: 6px; cursor: pointer; border: none; transition: background-color 0.3s;
        }

        /* 2.2 ä¸»å†…å®¹åŒºåŸŸ */
        .main-content { padding: 30px; overflow-y: auto; position: relative; }
        .content-module { display: none; animation: fadeInModule 0.5s ease-out; }
        .content-module.active { display: block; }
        @keyframes fadeInModule {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* 3. ä»»åŠ¡ä¸­å¿ƒå¸ƒå±€ */
        #task-module header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 20px; border-bottom: 2px solid #eee; padding-bottom: 15px;
        }
        #task-module h1 { color: var(--text-color); margin: 0; font-size: 1.8em; font-weight: 500; }
        .input-area {
            display: grid; grid-template-columns: 1fr auto auto auto; gap: 10px; margin-bottom: 20px;
            align-items: center;
        }
        .input-area button { grid-column: 4 / 5; } /* å°†æ·»åŠ æŒ‰é’®æ”¾åœ¨æœ€å */
        #taskInput { grid-column: 1 / 2; padding: 12px 15px; border: 1px solid #ddd; border-radius: 6px; }
        #dueDateInput, #priorityInput, #tagInput { padding: 12px 15px; border: 1px solid #ddd; border-radius: 6px; }
        #addButton { background-color: var(--success-color); color: white; padding: 12px 20px; border: none; border-radius: 6px; }

        /* ä»»åŠ¡åˆ—è¡¨ */
        #taskList { list-style: none; padding: 0; }
        #taskList li {
            display: flex; align-items: center; padding: 15px 20px; margin-bottom: 10px;
            background: var(--card-color); border-radius: 8px; box-shadow: 0 1px 6px rgba(0, 0, 0, 0.1);
            cursor: pointer; transition: all 0.3s ease; border-left: 5px solid transparent;
        }
        #taskList li[data-priority="High"] { border-left-color: var(--prio-high); }
        #taskList li[data-priority="Medium"] { border-left-color: var(--prio-medium); }
        #taskList li[data-priority="Low"] { border-left-color: var(--prio-low); }

        #taskList li.completed { background: #f0f4f7; color: #999; opacity: 0.8; }
        #taskList li.completed .task-text { text-decoration: line-through; }
        
        .task-content { display: flex; flex-direction: column; flex-grow: 1; padding-left: 15px; }
        .task-info-right { display: flex; align-items: center; gap: 15px; } /* ç¡®ä¿å³ä¾§å…ƒç´ å¯¹é½ */
        .due-date { font-size: 0.8em; color: #777; margin-top: 4px; }
        .due-date.expired { color: var(--secondary-color); font-weight: bold; }
        .task-tags {
            font-size: 0.75em; color: var(--primary-dark); background: #e0fff4;
            padding: 2px 6px; border-radius: 4px; font-weight: 500;
        }

        /* 4. æ•°æ®æ¦‚è§ˆé¡µ (Dashboard) */
        .stats-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px; margin-top: 20px;
        }
        .stat-card {
            background: var(--card-color); padding: 25px; border-radius: 10px; text-align: center;
            box-shadow: var(--shadow-subtle); border-bottom: 4px solid var(--primary-color);
        }
        .stat-card h3 { font-size: 1.1em; color: #7f8c8d; margin-bottom: 10px; }
        .stat-card .value { font-size: 2.8em; font-weight: bold; color: var(--primary-dark); }
        
        /* 5. è®¾ç½®ä¸åª’ä½“é¡µ */
        .settings-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; }
        .setting-box, .music-box { background: var(--card-color); padding: 25px; border-radius: 10px; box-shadow: var(--shadow-subtle); }
        .music-box audio { width: 100%; margin-top: 15px; }
        #applyThemeBtn { background: var(--primary-dark); color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; }
    </style>
</head>
<body>
    
    <div id="splashScreen">
        <div class="splash-text">
            <strong>Pro Task Manager</strong>
            <p>By TerryGao & Gemini</p>
        </div>
    </div>

    <div id="authScreen">
        <div class="auth-box">
            <h2><i class="fas fa-user-lock"></i> æœ¬åœ°ç”¨æˆ·è®¤è¯</h2>
            <p style="color:#e74c3c; font-size:12px; margin-bottom: 20px;">* æ•°æ®ä»…ä¿å­˜åœ¨æ­¤æµè§ˆå™¨ä¸­ï¼Œä¸å®‰å…¨ä¸”æ— æ³•è·¨è®¾å¤‡å…±äº«ã€‚</p>
            <input type="text" id="authUsername" placeholder="ç”¨æˆ·å" required>
            <input type="password" id="authPassword" placeholder="å¯†ç " required>
            <button id="loginBtn"><i class="fas fa-sign-in-alt"></i> ç™»å½•</button>
            <button id="registerBtn"><i class="fas fa-user-plus"></i> åˆ›å»ºæ–°è´¦å·</button>
        </div>
    </div>


    <div class="app-container">
        
        <div class="sidebar">
            <div>
                <h2><i class="fas fa-stream"></i> TaskFlow Manager</h2>
                <a class="nav-link active" data-module="task" id="navTask"><i class="fas fa-clipboard-list"></i> ä»»åŠ¡ä¸­å¿ƒ</a>
                <a class="nav-link" data-module="dashboard" id="navDashboard"><i class="fas fa-chart-line"></i> æ•°æ®æ¦‚è§ˆ</a>
                <a class="nav-link" data-module="settings" id="navSettings"><i class="fas fa-cogs"></i> è®¾ç½®ä¸åª’ä½“</a>
            </div>

            <div style="text-align: center; padding-bottom: 20px;">
                <span class="username-display" id="userDisplay" style="display: block; margin-bottom: 10px;"></span>
                <button id="logoutBtn"><i class="fas fa-sign-out-alt"></i> ç™»å‡º</button>
            </div>
        </div>

        <div class="main-content">

            <div id="task-module" class="content-module active">
                <header>
                    <h1>ä»»åŠ¡ä¸­å¿ƒ</h1>
                    <div class="filter-group">
                        <button class="filter-btn active" data-filter="all">å…¨éƒ¨</button>
                        <button class="filter-btn" data-filter="pending">å¾…åŠ</button>
                        <button class="filter-btn" data-filter="completed">å·²å®Œæˆ</button>
                    </div>
                </header>

                <div class="input-area">
                    <input type="text" id="taskInput" placeholder="è¯·è¾“å…¥æ–°ä»»åŠ¡å†…å®¹..." required>
                    <input type="date" id="dueDateInput" title="å¯é€‰ï¼šæˆªæ­¢æ—¥æœŸ">
                    <select id="priorityInput" title="è®¾ç½®ä¼˜å…ˆçº§">
                        <option value="Low">ä½ä¼˜å…ˆçº§</option>
                        <option value="Medium" selected>ä¸­ä¼˜å…ˆçº§</option>
                        <option value="High">é«˜ä¼˜å…ˆçº§</option>
                    </select>
                    <input type="text" id="tagInput" placeholder="æ ‡ç­¾ (å¦‚: å­¦ä¹ , ç´§æ€¥)" title="æ·»åŠ æ ‡ç­¾">
                    <button id="addButton"><i class="fas fa-plus"></i> æ·»åŠ </button>
                </div>
                
                <div class="task-controls" style="margin-bottom: 15px; display: flex; justify-content: space-between;">
                    <span class="task-count" id="pendingTaskCount">å½“å‰å¾…åŠï¼š0 ä¸ª</span>
                    <button id="clearCompletedBtn" style="background-color: #f39c12; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer;"><i class="fas fa-check-double"></i> æ¸…é™¤å·²å®Œæˆ</button>
                </div>

                <ul id="taskList">
                    </ul>
            </div>

            <div id="dashboard-module" class="content-module">
                <h1><i class="fas fa-chart-line"></i> ä»»åŠ¡æ•°æ®æ¦‚è§ˆ</h1>
                <p style="color:#7f8c8d;">å…¨å±€ä»»åŠ¡å®Œæˆåº¦å’Œåˆ†å¸ƒç»Ÿè®¡ã€‚</p>

                <div class="stats-grid">
                    <div class="stat-card" style="border-bottom-color: var(--primary-color);">
                        <h3>æ€»ä»»åŠ¡æ•°</h3>
                        <div class="value" id="totalTasksCount">0</div>
                    </div>
                    <div class="stat-card" style="border-bottom-color: var(--success-color);">
                        <h3>å®Œæˆç™¾åˆ†æ¯”</h3>
                        <div class="value" id="completionRate">0%</div>
                    </div>
                    <div class="stat-card" style="border-bottom-color: var(--prio-high);">
                        <h3>é«˜ä¼˜å…ˆçº§å¾…åŠ</h3>
                        <div class="value" id="highPrioCount">0</div>
                    </div>
                    <div class="stat-card" style="border-bottom-color: var(--prio-low);">
                        <h3>ä½ä¼˜å…ˆçº§å¾…åŠ</h3>
                        <div class="value" id="lowPrioCount">0</div>
                    </div>
                </div>

                <h2 style="margin-top: 40px; color: var(--primary-dark);"><i class="fas fa-list-ul"></i> ç»Ÿè®¡æ˜ç»†</h2>
                <div id="prio-chart-description" style="padding: 15px; background: #f9f9f9; border-radius: 8px;"></div>
            </div>

            <div id="settings-module" class="content-module">
                <h1><i class="fas fa-cogs"></i> è®¾ç½®ä¸åª’ä½“</h1>
                
                <div class="settings-grid">
                    <div class="music-box">
                        <h3><i class="fas fa-headphones"></i> ä¸“æ³¨æ¨¡å¼ä¼´ä¾£</h3>
                        <p style="font-size: 0.9em; color:#7f8c8d;">ä¸Šä¼ æœ¬åœ°éŸ³é¢‘æ–‡ä»¶ï¼Œè¾¹å¬è¾¹å·¥ä½œã€‚</p>
                        <input type="file" id="musicFile" accept="audio/*">
                        <audio id="audioPlayer" controls></audio>
                    </div>
                    
                    <div class="setting-box">
                        <h3><i class="fas fa-palette"></i> ä¸»é¢˜å¤–è§‚</h3>
                        <p>åˆ‡æ¢åº”ç”¨çš„ä¸»é¢˜é¢œè‰²ï¼š</p>
                        <select id="themeSelector" style="padding: 8px; border-radius: 4px; border: 1px solid #ddd;">
                            <option value="#1abc9c">ç°ä»£é’ç»¿ (é»˜è®¤)</option>
                            <option value="#3f51b5">æ²‰ç¨³å•†åŠ¡è“</option>
                            <option value="#e67e22">æ´»åŠ›æ©™</option>
                        </select>
                        <button id="applyThemeBtn">åº”ç”¨ä¸»é¢˜</button>
                    </div>
                </div>
            </div>

        </div>
    </div>
    
    <script>
        // --- ğŸ’¡ JavaScript æ ¸å¿ƒé€»è¾‘ ---

        // DOM å…ƒç´ è·å–
        const splashScreen = document.getElementById('splashScreen');
        const authScreen = document.getElementById('authScreen');
        const appContainer = document.querySelector('.app-container');
        const authUsername = document.getElementById('authUsername');
        const authPassword = document.getElementById('authPassword');
        const loginBtn = document.getElementById('loginBtn');
        const registerBtn = document.getElementById('registerBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const navLinks = document.querySelectorAll('.nav-link');
        const contentModules = document.querySelectorAll('.content-module');
        const userDisplay = document.getElementById('userDisplay');
        const totalTasksCount = document.getElementById('totalTasksCount');
        const completionRate = document.getElementById('completionRate');
        const highPrioCount = document.getElementById('highPrioCount');
        const lowPrioCount = document.getElementById('lowPrioCount');
        const prioChartDescription = document.getElementById('prio-chart-description');
        const themeSelector = document.getElementById('themeSelector');
        const applyThemeBtn = document.getElementById('applyThemeBtn');
        const musicFile = document.getElementById('musicFile');
        const audioPlayer = document.getElementById('audioPlayer');
        
        const taskInput = document.getElementById('taskInput');
        const dueDateInput = document.getElementById('dueDateInput');
        const priorityInput = document.getElementById('priorityInput');
        const tagInput = document.getElementById('tagInput');
        const addButton = document.getElementById('addButton');
        const taskList = document.getElementById('taskList');
        const pendingTaskCount = document.getElementById('pendingTaskCount');
        const filterButtons = document.querySelectorAll('.filter-group .filter-btn');
        const clearCompletedBtn = document.getElementById('clearCompletedBtn');

        let currentFilter = 'all'; 
        let currentUserName = '';

        // --- åˆå§‹åŒ–æµç¨‹ ---

        // 1. å¼€å¹•åŠ¨ç”»
        setTimeout(() => {
            splashScreen.style.opacity = '0';
            document.body.style.overflow = 'auto'; 
            setTimeout(() => {
                splashScreen.style.display = 'none';
                initApp(); 
            }, 1000);
        }, 3000); 

        function initApp() {
            authScreen.style.display = 'flex';
            const storedUser = localStorage.getItem('todoUser');
            if (storedUser) {
                 authUsername.value = JSON.parse(storedUser).username || ''; 
            }
            
            // ç»‘å®šäº‹ä»¶
            loginBtn.addEventListener('click', handleLogin);
            registerBtn.addEventListener('click', handleRegister);
            logoutBtn.addEventListener('click', handleLogout);
            navLinks.forEach(link => link.addEventListener('click', handleModuleSwitch));
            applyThemeBtn.addEventListener('click', applyTheme);
            musicFile.addEventListener('change', handleMusicUpload);

            addButton.addEventListener('click', addTask);
            taskInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') addTask();
            });

            taskList.addEventListener('click', handleTaskActions);
            taskList.addEventListener('dblclick', handleEditTask);
            filterButtons.forEach(button => button.addEventListener('click', handleFilterChange));
            clearCompletedBtn.addEventListener('click', clearCompletedTasks);

            setInterval(checkDueDates, 60000); 
            // åº”ç”¨ä¸Šæ¬¡ä¿å­˜çš„ä¸»é¢˜
            loadTheme();
        }

        // --- æ¨¡å—åˆ‡æ¢é€»è¾‘ ---

        function handleModuleSwitch(e) {
            const target = e.currentTarget;
            const targetModule = target.dataset.module;

            navLinks.forEach(link => link.classList.remove('active'));
            target.classList.add('active');

            contentModules.forEach(module => module.classList.remove('active'));
            document.getElementById(targetModule + '-module').classList.add('active');
            
            if (targetModule === 'dashboard') {
                updateDashboardStats();
            }
        }
        
        // --- ç™»å½•/ç™»å‡ºæ¨¡å— ---

        function handleLogin() {
            const user = authUsername.value.trim();
            const pass = authPassword.value;
            const storedUser = JSON.parse(localStorage.getItem('todoUser'));

            if (storedUser && storedUser.username === user && storedUser.password === pass) {
                currentUserName = user;
                userDisplay.textContent = `Hi, ${currentUserName}!`;
                document.body.classList.add('logged-in'); 
                authScreen.style.opacity = '0';
                setTimeout(() => {
                    authScreen.style.display = 'none';
                    appContainer.style.display = 'grid'; // æ˜¾ç¤ºä¸»å®¹å™¨
                    loadTasks(); 
                }, 500);
            } else {
                alert('ç™»å½•å¤±è´¥ï¼šç”¨æˆ·åæˆ–å¯†ç é”™è¯¯ï¼Œè¯·å°è¯•æ³¨å†Œã€‚');
            }
        }

        function handleRegister() {
            const user = authUsername.value.trim();
            const pass = authPassword.value;

            if (user === '' || pass.length < 3) {
                alert('ç”¨æˆ·åå’Œå¯†ç ä¸èƒ½ä¸ºç©ºï¼Œå¯†ç è‡³å°‘3ä½ã€‚');
                return;
            }
            if (localStorage.getItem('todoUser')) {
                 alert('æœ¬åœ°å·²å­˜åœ¨ç”¨æˆ·ï¼Œè¯·ç›´æ¥ç™»å½•ã€‚');
                 return;
            }

            const newUser = { username: user, password: pass, tasks: '' };
            localStorage.setItem('todoUser', JSON.stringify(newUser));
            alert(`è´¦å·åˆ›å»ºæˆåŠŸï¼Œè¯·ç™»å½•ï¼`);
            authPassword.value = pass; 
            handleLogin(); 
        }

        function handleLogout() {
            if (confirm('ç¡®å®šè¦ç™»å‡ºå—ï¼Ÿ')) {
                currentUserName = '';
                taskList.innerHTML = ''; 
                document.body.classList.remove('logged-in');
                appContainer.style.display = 'none';
                authScreen.style.display = 'flex';
                setTimeout(() => {
                    authScreen.style.opacity = '1';
                    authPassword.value = ''; 
                }, 100);
            }
        }

        // --- éŸ³ä¹æ’­æ”¾å™¨æ¨¡å— ---

        function handleMusicUpload(e) {
            const file = e.target.files[0];
            if (file && file.type.startsWith('audio/')) { 
                const fileURL = URL.createObjectURL(file);
                audioPlayer.src = fileURL;
                audioPlayer.play();
            } else {
                alert('è¯·é€‰æ‹©ä¸€ä¸ªæœ‰æ•ˆçš„éŸ³é¢‘æ–‡ä»¶ï¼ˆå¦‚mp3, wavç­‰ï¼‰');
                audioPlayer.src = '';
            }
        }

        // --- è®¾ç½®æ¨¡å— ---
        
        function applyTheme() {
            const newColor = themeSelector.value;
            // ç®€å•åœ°æ›´æ–° CSS å˜é‡
            document.documentElement.style.setProperty('--primary-color', newColor);
            
            // æ ¹æ®æ–°é¢œè‰²è®¡ç®—ä¸€ä¸ªæš—è‰²è°ƒ (ä½¿ç”¨é¢œè‰²æ··åˆé€»è¾‘ç®€åŒ–)
            const darkColor = shadeColor(newColor, -20);
            document.documentElement.style.setProperty('--primary-dark', darkColor);
            
            localStorage.setItem('themeColor', newColor);
            alert(`ä¸»é¢˜å·²åº”ç”¨ï¼æ–°ä¸»é¢˜è‰²ï¼š${newColor}`);
        }

        function loadTheme() {
            const savedColor = localStorage.getItem('themeColor');
            if (savedColor) {
                document.documentElement.style.setProperty('--primary-color', savedColor);
                const darkColor = shadeColor(savedColor, -20);
                document.documentElement.style.setProperty('--primary-dark', darkColor);
                themeSelector.value = savedColor;
            }
        }
        
        // ç®€æ˜“é¢œè‰²å¤„ç†å‡½æ•° (ä» HEX å˜æš—)
        function shadeColor(color, percent) {
            let R = parseInt(color.substring(1, 3), 16);
            let G = parseInt(color.substring(3, 5), 16);
            let B = parseInt(color.substring(5, 7), 16);

            R = parseInt(R * (100 + percent) / 100);
            G = parseInt(G * (100 + percent) / 100);
            B = parseInt(B * (100 + percent) / 100);

            R = (R < 255) ? R : 255;  
            G = (G < 255) ? G : 255;  
            B = (B < 255) ? B : 255;  

            const RR = ((R.toString(16).length === 1) ? '0' + R.toString(16) : R.toString(16));
            const GG = ((G.toString(16).length === 1) ? '0' + G.toString(16) : G.toString(16));
            const BB = ((B.toString(16).length === 1) ? '0' + B.toString(16) : B.toString(16));

            return '#' + RR + GG + BB;
        }

        // --- æ•°æ®æ¦‚è§ˆæ¨¡å— ---

        function updateDashboardStats() {
            const tasks = taskList.querySelectorAll('li');
            const total = tasks.length;
            const completed = taskList.querySelectorAll('li.completed').length;
            const pending = total - completed;
            
            // è®¡ç®—å¾…åŠä»»åŠ¡çš„ä¼˜å…ˆçº§åˆ†å¸ƒ
            const highPrio = taskList.querySelectorAll('li[data-priority="High"]:not(.completed)').length;
            const lowPrio = taskList.querySelectorAll('li[data-priority="Low"]:not(.completed)').length;
            const mediumPrio = pending - highPrio - lowPrio;

            totalTasksCount.textContent = total;
            
            const rate = total > 0 ? ((completed / total) * 100).toFixed(1) : 0;
            completionRate.textContent = `${rate}%`;
            
            highPrioCount.textContent = highPrio;
            lowPrioCount.textContent = lowPrio;

            prioChartDescription.innerHTML = `
                <p>æ€»å¾…åŠä»»åŠ¡æ•°ï¼š <strong>${pending}</strong> ä¸ª</p>
                <ul>
                    <li style="color:var(--prio-high);">é«˜ä¼˜å…ˆçº§ï¼š <strong>${highPrio}</strong> ä¸ª</li>
                    <li style="color:var(--prio-medium);">ä¸­ä¼˜å…ˆçº§ï¼š <strong>${mediumPrio}</strong> ä¸ª</li>
                    <li style="color:var(--prio-low);">ä½ä¼˜å…ˆçº§ï¼š <strong>${lowPrio}</strong> ä¸ª</li>
                </ul>
            `;
        }

        // --- æ ¸å¿ƒä»»åŠ¡ç®¡ç†å‡½æ•° (ä¿æŒ V5 é€»è¾‘) ---

        function handleTaskActions(e) {
            const target = e.target;
            const listItem = target.closest('li');
            if (!listItem) return;

            if (target.closest('.delete-btn')) {
                listItem.remove();
            } else if (target.closest('.task-content') || target.closest('li') === listItem) {
                if (listItem.classList.contains('editing')) return;
                
                listItem.classList.toggle('completed');
                
                const icon = listItem.querySelector('.fa-circle, .fa-check-circle');
                if (listItem.classList.contains('completed')) {
                    icon.classList.remove('fa-circle'); icon.classList.add('fa-check-circle');
                    icon.style.color = 'var(--success-color)';
                } else {
                    icon.classList.remove('fa-check-circle'); icon.classList.add('fa-circle');
                    icon.style.color = 'var(--primary-color)';
                }
                
                checkDueDates();
            }
            
            saveTasks();
            updateTaskCount();
            applyFilter();
        }

        function handleEditTask(e) {
            const listItem = e.target.closest('li');
            if (!listItem || listItem.classList.contains('completed')) return; 
            if (e.target.closest('.task-content')) enterEditMode(listItem);
        }

        function enterEditMode(listItem) {
            listItem.classList.add('editing');
            const editInput = listItem.querySelector('.edit-input');
            editInput.focus();
            editInput.onblur = () => {
                setTimeout(() => exitEditMode(listItem, editInput.value), 100); 
            };
        }

        function exitEditMode(listItem, newText) {
            listItem.classList.remove('editing');
            const textSpan = listItem.querySelector('.task-text');
            const editInput = listItem.querySelector('.edit-input');
            const trimmedText = newText.trim();
            if (trimmedText) {
                textSpan.textContent = trimmedText;
                editInput.value = trimmedText;
            } else {
                editInput.value = textSpan.textContent; 
            }
            saveTasks();
        }

        function clearCompletedTasks() {
            const completedTasks = taskList.querySelectorAll('li.completed');
            if (completedTasks.length === 0) { alert('æ²¡æœ‰å·²å®Œæˆçš„ä»»åŠ¡å¯æ¸…é™¤ã€‚'); return; }
            if (confirm(`ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰ ${completedTasks.length} ä¸ªå·²å®Œæˆçš„ä»»åŠ¡å—ï¼Ÿ`)) {
                completedTasks.forEach(task => task.remove());
                saveTasks(); updateTaskCount();
            }
        }

        function addTask() {
            const taskText = taskInput.value.trim();
            const dueDate = dueDateInput.value; 
            const priority = priorityInput.value; 
            const tag = tagInput.value.trim(); 

            if (taskText === '') { taskInput.focus(); return; }

            const listItem = document.createElement('li');
            listItem.dataset.priority = priority; 

            const checkIcon = document.createElement('i');
            checkIcon.classList.add('fas', 'fa-circle');
            checkIcon.style.color = 'var(--primary-color)';
            checkIcon.style.fontSize = '1.2em';
            checkIcon.style.cursor = 'pointer';
            
            const taskContent = document.createElement('div');
            taskContent.classList.add('task-content');

            const textSpan = document.createElement('span');
            textSpan.textContent = taskText;
            textSpan.classList.add('task-text');

            const editInput = document.createElement('input');
            editInput.type = 'text'; editInput.value = taskText; editInput.classList.add('edit-input');
            editInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') exitEditMode(listItem, editInput.value);
            });

            const subInfoDiv = document.createElement('div');
            subInfoDiv.style.display = 'flex'; subInfoDiv.style.gap = '10px';
            
            const dateSpan = document.createElement('span');
            dateSpan.classList.add('due-date'); dateSpan.dataset.dueDate = dueDate; 
            if (dueDate) { dateSpan.textContent = `æˆªæ­¢ï¼š${formatDateDisplay(dueDate)}`; subInfoDiv.appendChild(dateSpan); }

            if (tag) { 
                const tagSpan = document.createElement('span');
                tagSpan.classList.add('task-tags'); tagSpan.textContent = tag;
                subInfoDiv.appendChild(tagSpan);
            }

            taskContent.appendChild(textSpan); taskContent.appendChild(editInput); taskContent.appendChild(subInfoDiv);

            const deleteBtn = document.createElement('span');
            deleteBtn.innerHTML = '<i class="fas fa-trash-alt"></i>'; deleteBtn.classList.add('delete-btn');

            listItem.appendChild(checkIcon);
            listItem.appendChild(taskContent);
            listItem.appendChild(deleteBtn);
            taskList.appendChild(listItem);

            taskInput.value = ''; dueDateInput.value = ''; tagInput.value = ''; priorityInput.value = 'Medium';
            taskInput.focus();

            checkDueDates(); saveTasks(); updateTaskCount(); applyFilter(); 
        }

        function checkDueDates() {
            const now = new Date(); now.setHours(0, 0, 0, 0); 

            taskList.querySelectorAll('li').forEach(listItem => {
                const dateSpan = listItem.querySelector('.due-date');
                const icon = listItem.querySelector('.fa-circle, .fa-check-circle');

                if (listItem.classList.contains('completed')) {
                    icon.classList.remove('fa-circle'); icon.classList.add('fa-check-circle'); icon.style.color = 'var(--success-color)';
                } else {
                    icon.classList.remove('fa-check-circle'); icon.classList.add('fa-circle'); icon.style.color = 'var(--primary-color)';
                }
                
                if (dateSpan) {
                    const dueDateString = dateSpan.dataset.dueDate;
                    if (dueDateString) {
                        const dueDate = new Date(dueDateString); dueDate.setHours(0, 0, 0, 0); 
                        
                        if (listItem.classList.contains('completed')) { dateSpan.classList.remove('expired'); dateSpan.textContent = `æˆªæ­¢ï¼š${formatDateDisplay(dueDateString)}`; } 
                        else if (dueDate < now) { 
                            dateSpan.classList.add('expired'); dateSpan.textContent = `æˆªæ­¢ï¼š${formatDateDisplay(dueDateString)} (å·²è¿‡æœŸ)`; 
                        } else { dateSpan.classList.remove('expired'); dateSpan.textContent = `æˆªæ­¢ï¼š${formatDateDisplay(dueDateString)}`; }
                    }
                }
            });
        }

        function formatDateDisplay(dateString) {
            const date = new Date(dateString); return `${date.getMonth() + 1}æœˆ${date.getDate()}æ—¥`;
        }

        function updateTaskCount() {
            const pendingTasks = taskList.querySelectorAll('li:not(.completed)').length;
            pendingTaskCount.textContent = `å½“å‰å¾…åŠï¼š${pendingTasks} ä¸ª`;
        }

        function applyFilter() {
            const tasks = taskList.querySelectorAll('li');
            tasks.forEach(task => {
                const isCompleted = task.classList.contains('completed');
                let shouldShow = true;

                if (currentFilter === 'pending' && isCompleted) shouldShow = false;
                else if (currentFilter === 'completed' && !isCompleted) shouldShow = false;
                
                task.style.display = shouldShow ? 'flex' : 'none';
            });
        }

        function saveTasks() {
            const storedUser = JSON.parse(localStorage.getItem('todoUser'));
            if (!storedUser) return;
            storedUser.tasks = taskList.innerHTML; 
            localStorage.setItem('todoUser', JSON.stringify(storedUser));
        }

        function loadTasks() {
            const storedUser = JSON.parse(localStorage.getItem('todoUser'));
            if (!storedUser || storedUser.username !== currentUserName) return;

            taskList.innerHTML = storedUser.tasks || ''; 
            userDisplay.textContent = `Hi, ${currentUserName}!`;
            checkDueDates();
            updateTaskCount();
        }
    </script>
</body>
</html>
