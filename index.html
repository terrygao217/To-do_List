<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸“ä¸šä»»åŠ¡ç®¡ç†ç³»ç»Ÿ - Final Pro Version V10</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* --- ğŸ¨ V10 CSS æ ·å¼å®šä¹‰ --- */
        :root {
            --primary-color: #1abc9c; /* å“ç‰Œè‰² - ç°ä»£é’ç»¿è‰² */
            --primary-dark: #16a085;
            --secondary-color: #e74c3c; /* çº¢è‰²ï¼šç”¨äºè¿‡æœŸå’Œé”™è¯¯ */
            --success-color: #2ecc71; /* ç»¿è‰²ï¼šç”¨äºå®Œæˆ */
            --bg-color: #ecf0f1; /* æµ…ç°èƒŒæ™¯ */
            --sidebar-color: #34495e; /* æ·±è“è‰²ä¾§è¾¹æ  */
            --card-color: #ffffff;
            --text-color: #2c3e50; 
            --shadow-elevation: 0 8px 25px rgba(0, 0, 0, 0.15); 
            
            --prio-high: #e74c3c;
            --prio-medium: #f39c12;
            --prio-low: #2ecc71;
        }

        body {
            font-family: 'Roboto', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            color: var(--text-color);
            overflow: hidden; 
        }

        /* 1. å¼€å¹•ç•Œé¢ */
        #splashScreen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            color: white; z-index: 1000; opacity: 1; transition: opacity 1s ease-out; font-size: 2em;
        }
        .splash-text { animation: bounceIn 1.5s ease-out forwards; font-weight: 300; text-align: center; }
        .splash-text strong { font-weight: 700; display: block; font-size: 3.5em; margin-bottom: 10px; }
        @keyframes bounceIn {
            0% { opacity: 0; transform: scale(0.3); } 50% { opacity: 1; transform: scale(1.1); }
            70% { transform: scale(0.9); } 100% { transform: scale(1); }
        }

        /* 2. æ¨¡æ‹Ÿç™»å½•/æ³¨å†Œç•Œé¢ (ç¾åŒ–) */
        #authScreen {
            position: fixed; width: 100%; height: 100%; backdrop-filter: blur(10px); 
            background-color: rgba(0, 0, 0, 0.5); z-index: 999; display: none; justify-content: center; align-items: center;
            opacity: 1; transition: opacity 0.5s;
        }
        .auth-box {
            background: rgba(255, 255, 255, 0.95); padding: 40px; border-radius: 15px; width: 380px; text-align: center;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3); transform: translateY(-20px); 
            animation: slideUp 0.6s ease-out forwards;
        }
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(50px); } to { opacity: 1; transform: translateY(-20px); }
        }
        .auth-box h2 { color: var(--primary-dark); margin-bottom: 25px; font-weight: 600; border-bottom: 2px solid #eee; padding-bottom: 15px; }
        .auth-box input { width: 100%; padding: 14px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
        .auth-box button { width: 100%; padding: 14px; border: none; border-radius: 8px; cursor: pointer; margin-bottom: 10px; transition: background-color 0.3s, transform 0.1s; }
        #loginBtn { background-color: var(--primary-color); color: white; }
        #registerBtn { background-color: #6c757d; color: white; }

        /* 3. ä¸»åº”ç”¨å¸ƒå±€ */
        .app-container {
            display: none; width: 90%; max-width: 1200px; height: 85vh;
            background: var(--card-color); border-radius: 15px;
            box-shadow: var(--shadow-elevation); overflow: hidden;
            grid-template-columns: 250px 1fr;
        }
        body.logged-in .app-container { display: grid; }
        .sidebar { background-color: var(--sidebar-color); padding: 20px; color: white; display: flex; flex-direction: column; justify-content: space-between;}
        .sidebar h2 { font-size: 1.4em; margin-bottom: 25px; border-bottom: 1px solid rgba(255, 255, 255, 0.1); padding-bottom: 15px; }
        .nav-link { display: block; padding: 12px 15px; text-decoration: none; color: rgba(255, 255, 255, 0.8); border-radius: 6px; margin-bottom: 8px; transition: background-color 0.3s; }
        .nav-link:hover { background-color: rgba(255, 255, 255, 0.1); }
        .nav-link.active { background-color: var(--primary-color); color: white; font-weight: bold; }
        .nav-link i { margin-right: 10px; }
        .main-content { padding: 30px; overflow-y: auto; }
        .content-module { display: none; }
        .content-module.active { display: block; }

        /* ä»»åŠ¡ä¸­å¿ƒå¸ƒå±€ */
        #task-module header {
            display: flex; justify-content: space-between; align-items: flex-start; 
            margin-bottom: 20px; border-bottom: 2px solid #eee; padding-bottom: 15px;
        }
        /* å®æ—¶æ—¶é’Ÿé¢æ¿ (ç¾åŒ–) */
        .header-controls { display: flex; flex-direction: column; align-items: flex-end; gap: 10px; }
        #timeDisplay {
            background-color: var(--primary-color); color: white; padding: 8px 15px;
            border-radius: 8px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); font-size: 1.1em;
            font-weight: 500; text-align: right; line-height: 1.4;
        }
        #timeDisplay .time-sec { font-size: 0.8em; opacity: 0.8; margin-left: 5px; }
        #timeDisplay .date-week { display: block; font-size: 0.9em; opacity: 0.9; }
        .filter-group { display: flex; gap: 5px; }
        .filter-btn { background: #eee; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; transition: background 0.2s; }
        .filter-btn.active { background: var(--primary-dark); color: white; }
        
        /* ä»»åŠ¡è¾“å…¥åŒºåŸŸ */
        #searchBar { padding: 10px 15px; border: 1px solid #ccc; border-radius: 6px; width: 100%; margin-bottom: 20px; }
        .input-area { grid-template-columns: 1fr auto auto auto auto; gap: 10px; margin-bottom: 20px; align-items: center; }
        .input-area input, .input-area select { padding: 12px 15px; border: 1px solid #ddd; border-radius: 6px; }
        .input-area button { padding: 12px 20px; background-color: var(--success-color); color: white; border: none; border-radius: 6px; cursor: pointer;}
        
        /* ä»»åŠ¡åˆ—è¡¨ */
        #taskList li {
            display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; margin-bottom: 10px;
            background: var(--card-color); border-radius: 8px; box-shadow: 0 1px 6px rgba(0, 0, 0, 0.1);
            cursor: pointer; border-left: 5px solid transparent; transition: border-left 0.3s;
        }
        #taskList li[data-priority="High"] { border-left-color: var(--prio-high); }
        #taskList li[data-priority="Medium"] { border-left-color: var(--prio-medium); }
        #taskList li[data-priority="Low"] { border-left-color: var(--prio-low); }
        #taskList li.completed { opacity: 0.6; }
        .task-content { display: flex; flex-direction: column; flex-grow: 1; padding-left: 15px; }
        .task-timestamps { display: flex; gap: 15px; font-size: 0.8em; color: #7f8c8d; margin-top: 4px; }
        .task-timestamps .fa-clock, .due-date .fa-calendar-alt { color: var(--primary-dark); }
        .due-date { font-weight: 500; color: var(--text-color); font-size: 0.9em; }
        .due-date.expired { color: var(--secondary-color); font-weight: bold; }
        .task-text { font-weight: 600; font-size: 1.1em; }
        .delete-btn { color: var(--secondary-color); cursor: pointer; opacity: 0.7; transition: opacity 0.2s; }

        /* æ’åºæ§åˆ¶ */
        .sort-control { display: flex; align-items: center; gap: 10px; margin-bottom: 15px; padding: 10px 0; border-top: 1px solid #eee; }
        .sort-control select { padding: 8px; border-radius: 4px; border: 1px solid #ccc; }

        /* æ•°æ®æ¦‚è§ˆé¡µ (Dashboard) */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-top: 20px; }
        .stat-card { background: var(--card-color); padding: 25px; border-radius: 10px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1); border-bottom: 4px solid var(--primary-color); }
        .stat-card h3 { color: #777; margin-top: 0; }
        .stat-card .value { font-size: 2.5em; font-weight: bold; }
        
        /* è®¾ç½®ä¸åª’ä½“é¡µ */
        .settings-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; }
        .setting-box, .music-box { background: var(--card-color); padding: 25px; border-radius: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .music-box audio { width: 100%; margin-top: 15px; }
        .file-controls { margin-top: 20px; }
        .file-controls button { padding: 10px 15px; margin-right: 10px; border: none; border-radius: 4px; cursor: pointer; color: white;}
        #exportBtn { background-color: var(--success-color); }
        #importFile { display: none; }
        #importBtn { background-color: #3498db; }
    </style>
</head>
<body>
    
    <div id="splashScreen">
        <div class="splash-text">
            <strong>Pro Task Manager</strong>
            <p>UI/UX Enhanced by TerryGao & Gemini</p>
        </div>
    </div>

    <div id="authScreen">
        <div class="auth-box">
            <h2><i class="fas fa-lock"></i> æ¬¢è¿ç™»å½•</h2>
            <p style="color:#777; font-size:12px; margin-bottom: 20px;">ä½¿ç”¨æœ¬åœ°è´¦æˆ·ç®¡ç†ä»»åŠ¡ã€‚</p>
            <input type="text" id="authUsername" placeholder="ç”¨æˆ·å" required>
            <input type="password" id="authPassword" placeholder="å¯†ç " required>
            <button id="loginBtn"><i class="fas fa-sign-in-alt"></i> ç™»å½•</button>
            <button id="registerBtn"><i class="fas fa-user-plus"></i> åˆ›å»ºæ–°è´¦å·</button>
        </div>
    </div>


    <div class="app-container">
        
        <div class="sidebar">
            <div>
                <h2><i class="fas fa-stream"></i> TaskFlow Manager</h2>
                <a class="nav-link active" data-module="task" id="navTask"><i class="fas fa-clipboard-list"></i> ä»»åŠ¡ä¸­å¿ƒ</a>
                <a class="nav-link" data-module="dashboard" id="navDashboard"><i class="fas fa-chart-line"></i> æ•°æ®æ¦‚è§ˆ</a>
                <a class="nav-link" data-module="settings" id="navSettings"><i class="fas fa-cogs"></i> è®¾ç½®ä¸åª’ä½“</a>
            </div>

            <div style="text-align: center; padding-bottom: 20px;">
                <span class="username-display" id="userDisplay" style="display: block; margin-bottom: 10px;"></span>
                <button id="logoutBtn"><i class="fas fa-sign-out-alt"></i> ç™»å‡º</button>
            </div>
        </div>

        <div class="main-content">

            <div id="task-module" class="content-module active">
                <header>
                    <h1>ä»»åŠ¡ä¸­å¿ƒ</h1>
                    <div class="header-controls">
                        <div id="timeDisplay"></div>
                        <div class="filter-group">
                            <button class="filter-btn active" data-filter="all">å…¨éƒ¨</button>
                            <button class="filter-btn" data-filter="pending">å¾…åŠ</button>
                            <button class="filter-btn" data-filter="completed">å·²å®Œæˆ</button>
                        </div>
                    </div>
                </header>
                
                <input type="text" id="searchBar" placeholder="ğŸ” å¿«é€Ÿæœç´¢ä»»åŠ¡ (å…³é”®å­—æˆ–æ ‡ç­¾)">

                <div class="input-area">
                    <input type="text" id="taskInput" placeholder="è¯·è¾“å…¥æ–°ä»»åŠ¡å†…å®¹..." required>
                    <input type="date" id="dueDateInput" title="å¯é€‰ï¼šæˆªæ­¢æ—¥æœŸ">
                    <input type="time" id="dueTimeInput" title="å¯é€‰ï¼šæˆªæ­¢æ—¶é—´"> 
                    <select id="priorityInput" title="è®¾ç½®ä¼˜å…ˆçº§">
                        <option value="Low">ä½</option>
                        <option value="Medium" selected>ä¸­</option>
                        <option value="High">é«˜</option>
                    </select>
                    <input type="text" id="tagInput" placeholder="æ ‡ç­¾ (å¦‚: å­¦ä¹ , ç´§æ€¥)" title="æ·»åŠ æ ‡ç­¾">
                    <button id="addButton"><i class="fas fa-plus"></i> æ·»åŠ </button>
                </div>
                
                <div class="sort-control">
                    <label for="sortSelector"><i class="fas fa-sort-amount-down"></i> æ’åºæ–¹å¼:</label>
                    <select id="sortSelector">
                        <option value="creation_desc">åˆ›å»ºæ—¶é—´ (æœ€æ–°)</option>
                        <option value="creation_asc">åˆ›å»ºæ—¶é—´ (æœ€æ—§)</option>
                        <option value="due_asc">æˆªæ­¢æ—¶é—´ (æœ€æ—©)</option>
                        <option value="due_desc">æˆªæ­¢æ—¶é—´ (æœ€æ™š)</option>
                        <option value="priority_desc">ä¼˜å…ˆçº§ (æœ€é«˜)</option>
                    </select>
                </div>

                <div class="task-controls" style="margin-bottom: 15px; display: flex; justify-content: space-between;">
                    <span class="task-count" id="pendingTaskCount">å½“å‰å¾…åŠï¼š0 ä¸ª</span>
                    <button id="clearCompletedBtn"><i class="fas fa-check-double"></i> æ¸…é™¤å·²å®Œæˆ</button>
                </div>

                <ul id="taskList">
                    </ul>
            </div>

            <div id="dashboard-module" class="content-module">
                 <h1><i class="fas fa-chart-line"></i> ä»»åŠ¡æ•°æ®æ¦‚è§ˆ</h1>
                <p style="color:#7f8c8d;">å…¨å±€ä»»åŠ¡å®Œæˆåº¦å’Œåˆ†å¸ƒç»Ÿè®¡ã€‚</p>

                <div class="stats-grid">
                    <div class="stat-card" style="border-bottom-color: var(--primary-color);">
                        <h3>æ€»ä»»åŠ¡æ•°</h3>
                        <div class="value" id="totalTasksCount">0</div>
                    </div>
                    <div class="stat-card" style="border-bottom-color: var(--success-color);">
                        <h3>å®Œæˆç™¾åˆ†æ¯”</h3>
                        <div class="value" id="completionRate">0%</div>
                    </div>
                    <div class="stat-card" style="border-bottom-color: var(--prio-high);">
                        <h3>é«˜ä¼˜å…ˆçº§å¾…åŠ</h3>
                        <div class="value" id="highPrioCount">0</div>
                    </div>
                    <div class="stat-card" style="border-bottom-color: var(--prio-low);">
                        <h3>ä½ä¼˜å…ˆçº§å¾…åŠ</h3>
                        <div class="value" id="lowPrioCount">0</div>
                    </div>
                </div>

                <h2 style="margin-top: 40px; color: var(--primary-dark);"><i class="fas fa-list-ul"></i> ç»Ÿè®¡æ˜ç»†</h2>
                <div id="prio-chart-description" style="padding: 15px; background: #f9f9f9; border-radius: 8px;"></div>
                
                <h2 style="margin-top: 40px; color: var(--primary-dark);"><i class="fas fa-history"></i> ä»»åŠ¡å†å²è®°å½• (æ¨¡æ‹Ÿ)</h2>
                <div id="history-chart-description" style="padding: 15px; background: #f9f9f9; border-radius: 8px;">
                    <p style="color:#7f8c8d;">æ‚¨ä¸Šå‘¨å®Œæˆäº† 5 ä¸ªä»»åŠ¡ï¼Œæœ¬å‘¨å®Œæˆäº† 3 ä¸ªä»»åŠ¡ã€‚ä¿æŒä¸“æ³¨ï¼</p>
                </div>
            </div>

            <div id="settings-module" class="content-module">
                <h1><i class="fas fa-cogs"></i> è®¾ç½®ä¸åª’ä½“</h1>
                
                <div class="settings-grid">
                    <div class="music-box">
                        <h3><i class="fas fa-headphones"></i> ä¸“æ³¨æ¨¡å¼ä¼´ä¾£</h3>
                        <p style="font-size: 0.9em; color:#7f8c8d;">ä¸Šä¼ æœ¬åœ°éŸ³é¢‘æ–‡ä»¶ï¼Œè¾¹å¬è¾¹å·¥ä½œã€‚</p>
                        <input type="file" id="musicFile" accept="audio/*">
                        <audio id="audioPlayer" controls></audio>
                        <p id="musicError" style="color:var(--secondary-color); font-size:0.8em; margin-top:10px; display:none;">*æç¤ºï¼šè‹¥æ— æ³•æ’­æ”¾ï¼Œå¯èƒ½æ˜¯æµè§ˆå™¨å®‰å…¨é™åˆ¶ï¼Œè¯·å°è¯•ä½¿ç”¨PCç«¯æµè§ˆå™¨ã€‚</p>
                    </div>
                    
                    <div class="setting-box">
                        <h3><i class="fas fa-palette"></i> ä¸»é¢˜å¤–è§‚</h3>
                        <p>åˆ‡æ¢åº”ç”¨çš„ä¸»é¢˜é¢œè‰²ï¼š</p>
                        <select id="themeSelector">
                            <option value="#1abc9c">ç°ä»£é’ç»¿ (é»˜è®¤)</option>
                            <option value="#3f51b5">æ²‰ç¨³å•†åŠ¡è“</option>
                            <option value="#e67e22">æ´»åŠ›æ©™</option>
                        </select>
                        <button id="applyThemeBtn">åº”ç”¨ä¸»é¢˜</button>
                    </div>
                    
                    <div class="setting-box" style="grid-column: 1 / 3;">
                         <h3><i class="fas fa-file-export"></i> æ•°æ®å¤‡ä»½ä¸æ¢å¤</h3>
                         <p style="font-size: 0.9em; color:#7f8c8d;">å°†æ‚¨çš„ä»»åŠ¡åˆ—è¡¨å¯¼å‡ºä¸ºJSONæ–‡ä»¶è¿›è¡Œæœ¬åœ°å¤‡ä»½ã€‚</p>
                         <div class="file-controls">
                             <button id="exportBtn"><i class="fas fa-download"></i> å¯¼å‡ºä»»åŠ¡</button>
                             
                             <input type="file" id="importFile" accept=".json">
                             <button id="importBtn" onclick="document.getElementById('importFile').click()"><i class="fas fa-upload"></i> å¯¼å…¥ä»»åŠ¡</button>
                         </div>
                    </div>
                </div>
            </div>

        </div>
    </div>
    
    <script>
        // --- ğŸ’¡ JavaScript æ ¸å¿ƒé€»è¾‘ï¼šæ‰€æœ‰åŠŸèƒ½æ•´åˆ ---

        // DOM å…ƒç´ è·å– (çœç•¥é‡å¤éƒ¨åˆ†ï¼Œåªåˆ—å‡ºå…³é”®å…ƒç´ )
        const splashScreen = document.getElementById('splashScreen');
        const authScreen = document.getElementById('authScreen');
        const appContainer = document.querySelector('.app-container');
        const taskList = document.getElementById('taskList');
        const timeDisplay = document.getElementById('timeDisplay');
        const musicFile = document.getElementById('musicFile');
        const audioPlayer = document.getElementById('audioPlayer');
        const musicError = document.getElementById('musicError');
        const themeSelector = document.getElementById('themeSelector');
        const applyThemeBtn = document.getElementById('applyThemeBtn');
        const exportBtn = document.getElementById('exportBtn');
        const importFile = document.getElementById('importFile');
        const sortSelector = document.getElementById('sortSelector');
        const searchBar = document.getElementById('searchBar');
        const filterButtons = document.querySelectorAll('.filter-group .filter-btn');
        const clearCompletedBtn = document.getElementById('clearCompletedBtn');
        
        let currentFilter = 'all'; 
        let currentUserName = '';

        // --- 1. åˆå§‹åŒ–å’Œå¯åŠ¨æµç¨‹ ---

        // å¼€å¹•åŠ¨ç”»æ§åˆ¶ (V9 é€»è¾‘)
        setTimeout(() => {
            splashScreen.style.opacity = '0';
            document.body.style.overflow = 'auto'; 
            setTimeout(() => {
                splashScreen.style.display = 'none';
                initApp(); 
            }, 1000);
        }, 3000); 

        function initApp() {
            authScreen.style.display = 'flex';
            const storedUser = localStorage.getItem('todoUser');
            if (storedUser) {
                 document.getElementById('authUsername').value = JSON.parse(storedUser).username || ''; 
            }
            
            // ç»‘å®šäº‹ä»¶
            document.getElementById('loginBtn').addEventListener('click', handleLogin);
            document.getElementById('registerBtn').addEventListener('click', handleRegister);
            document.getElementById('logoutBtn').addEventListener('click', handleLogout);
            document.querySelectorAll('.nav-link').forEach(link => link.addEventListener('click', handleModuleSwitch));
            document.getElementById('addButton').addEventListener('click', addTask);
            taskList.addEventListener('click', handleTaskActions);
            filterButtons.forEach(button => button.addEventListener('click', handleFilterChange));
            clearCompletedBtn.addEventListener('click', clearCompletedTasks);
            sortSelector.addEventListener('change', sortTasks);
            searchBar.addEventListener('input', applyFilter);
            musicFile.addEventListener('change', handleMusicUpload);
            applyThemeBtn.addEventListener('click', applyTheme);
            exportBtn.addEventListener('click', exportTasks);
            importFile.addEventListener('change', importTasks);

            // å¯åŠ¨å®æ—¶æ—¶é’Ÿå’Œæ—¥æœŸæ£€æŸ¥
            updateClock();
            setInterval(updateClock, 1000); 
            setInterval(checkDueDates, 60000); 
            loadTheme();
        }

        // --- 2. å®æ—¶æ—¶é’ŸåŠŸèƒ½ (V10 æ ¸å¿ƒæ–°å¢) ---
        function updateClock() {
            const now = new Date();
            const year = now.getFullYear();
            const month = now.getMonth() + 1;
            const day = now.getDate();
            const hour = now.getHours().toString().padStart(2, '0');
            const minute = now.getMinutes().toString().padStart(2, '0');
            const second = now.getSeconds().toString().padStart(2, '0');
            
            const daysOfWeek = ['å‘¨æ—¥', 'å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­'];
            const weekDay = daysOfWeek[now.getDay()];

            const dateStr = `${year}å¹´${month}æœˆ${day}æ—¥ ${weekDay}`;
            const timeStr = `${hour}:${minute}`;
            const secStr = `${second}`;

            timeDisplay.innerHTML = `
                ${timeStr}<span class="time-sec">:${secStr}</span>
                <span class="date-week">${dateStr}</span>
            `;
        }

        // --- 3. ç™»å½•/ç™»å‡ºå’Œæ¨¡å—åˆ‡æ¢ (V9 é€»è¾‘) ---

        function handleLogin() {
            const user = document.getElementById('authUsername').value.trim();
            const pass = document.getElementById('authPassword').value;
            const storedUser = JSON.parse(localStorage.getItem('todoUser'));

            if (storedUser && storedUser.username === user && storedUser.password === pass) {
                currentUserName = user;
                document.getElementById('userDisplay').textContent = `Hi, ${currentUserName}!`;
                document.body.classList.add('logged-in'); 
                document.getElementById('authScreen').style.opacity = '0';
                setTimeout(() => {
                    document.getElementById('authScreen').style.display = 'none';
                    appContainer.style.display = 'grid';
                    loadTasks(); 
                }, 500);
            } else {
                alert('ç™»å½•å¤±è´¥ï¼šç”¨æˆ·åæˆ–å¯†ç é”™è¯¯ï¼Œè¯·å°è¯•æ³¨å†Œã€‚');
            }
        }
        
        function handleRegister() {
             const user = document.getElementById('authUsername').value.trim();
            const pass = document.getElementById('authPassword').value;

            if (user === '' || pass.length < 3) { alert('ç”¨æˆ·åå’Œå¯†ç ä¸èƒ½ä¸ºç©ºï¼Œå¯†ç è‡³å°‘3ä½ã€‚'); return; }
            if (localStorage.getItem('todoUser')) { alert('æœ¬åœ°å·²å­˜åœ¨ç”¨æˆ·ï¼Œè¯·ç›´æ¥ç™»å½•ã€‚'); return; }

            const newUser = { username: user, password: pass, tasks: '' };
            localStorage.setItem('todoUser', JSON.stringify(newUser));
            alert(`è´¦å·åˆ›å»ºæˆåŠŸï¼Œè¯·ç™»å½•ï¼`);
            document.getElementById('authPassword').value = pass; 
            handleLogin(); 
        }

        function handleLogout() {
            if (confirm('ç¡®å®šè¦ç™»å‡ºå—ï¼Ÿ')) {
                currentUserName = ''; taskList.innerHTML = ''; 
                document.body.classList.remove('logged-in');
                appContainer.style.display = 'none';
                authScreen.style.display = 'flex';
                setTimeout(() => { authScreen.style.opacity = '1'; document.getElementById('authPassword').value = ''; }, 100);
            }
        }
        
        function handleModuleSwitch(e) {
            const target = e.currentTarget;
            const targetModule = target.dataset.module;

            document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
            target.classList.add('active');

            document.querySelectorAll('.content-module').forEach(module => module.classList.remove('active'));
            document.getElementById(targetModule + '-module').classList.add('active');
            
            if (targetModule === 'dashboard') { updateDashboardStats(); }
        }

        // --- 4. ä»»åŠ¡æ ¸å¿ƒåŠŸèƒ½ (å¢åˆ æ”¹æŸ¥, æ’åº, è¿‡æ»¤, V9/V8 é€»è¾‘) ---
        
        function addTask() {
            const taskText = document.getElementById('taskInput').value.trim();
            const dueDate = document.getElementById('dueDateInput').value; 
            const dueTime = document.getElementById('dueTimeInput').value; 
            const priority = document.getElementById('priorityInput').value; 
            const tag = document.getElementById('tagInput').value.trim(); 
            const creationTime = new Date().toISOString(); 

            if (taskText === '') { document.getElementById('taskInput').focus(); return; }

            const listItem = document.createElement('li');
            listItem.dataset.priority = priority; 
            listItem.dataset.creationTime = creationTime; 
            
            let fullDueTime = '';
            if (dueDate) {
                fullDueTime = dueDate + (dueTime ? 'T' + dueTime : 'T23:59');
                listItem.dataset.fullDueTime = fullDueTime;
            }

            const checkIcon = document.createElement('i');
            checkIcon.classList.add('fas', 'fa-circle'); checkIcon.style.color = 'var(--primary-color)';
            checkIcon.style.fontSize = '1.2em'; checkIcon.style.cursor = 'pointer';
            
            const taskContent = document.createElement('div'); taskContent.classList.add('task-content');

            const textSpan = document.createElement('span'); textSpan.textContent = taskText; textSpan.classList.add('task-text');
            
            const subInfoDiv = document.createElement('div'); subInfoDiv.style.display = 'flex'; subInfoDiv.style.gap = '15px'; subInfoDiv.style.flexWrap = 'wrap';
            
            // æˆªæ­¢æ—¶é—´æ˜¾ç¤º
            if (dueDate) { 
                const dateSpan = document.createElement('span');
                dateSpan.classList.add('due-date');
                dateSpan.innerHTML = `<i class="far fa-calendar-alt"></i> ${formatDateDisplay(fullDueTime, true)}`; 
                subInfoDiv.appendChild(dateSpan);
            }

            // æ ‡ç­¾æ˜¾ç¤º
            if (tag) { 
                const tagSpan = document.createElement('span'); tagSpan.classList.add('task-tags'); tagSpan.textContent = tag;
                subInfoDiv.appendChild(tagSpan);
            }

            // åˆ›å»ºæ—¶é—´æ˜¾ç¤º
            const timeStampDiv = document.createElement('div'); timeStampDiv.classList.add('task-timestamps');
            timeStampDiv.innerHTML = `<i class="far fa-clock"></i> åˆ›å»ºäº: ${formatDateDisplay(creationTime, true)}`;
            subInfoDiv.appendChild(timeStampDiv);

            taskContent.appendChild(textSpan); taskContent.appendChild(subInfoDiv);

            const deleteBtn = document.createElement('span');
            deleteBtn.innerHTML = '<i class="fas fa-trash-alt"></i>'; deleteBtn.classList.add('delete-btn');

            listItem.appendChild(checkIcon); listItem.appendChild(taskContent); listItem.appendChild(deleteBtn);
            taskList.appendChild(listItem);

            document.getElementById('taskInput').value = ''; document.getElementById('dueDateInput').value = ''; 
            document.getElementById('dueTimeInput').value = ''; document.getElementById('tagInput').value = ''; 
            document.getElementById('priorityInput').value = 'Medium';
            document.getElementById('taskInput').focus();

            checkDueDates(); saveTasks(); updateTaskCount(); applyFilter(); sortTasks();
        }

        function handleTaskActions(e) {
            const target = e.target;
            const listItem = target.closest('li');
            if (!listItem) return;

            if (target.closest('.delete-btn')) { listItem.remove(); } 
            else if (target.closest('li') === listItem && !listItem.classList.contains('editing')) {
                listItem.classList.toggle('completed');
                checkDueDates();
            }
            
            saveTasks(); updateTaskCount(); applyFilter();
        }

        function checkDueDates() {
            const now = new Date();

            taskList.querySelectorAll('li').forEach(listItem => {
                const dateSpan = listItem.querySelector('.due-date');
                const icon = listItem.querySelector('.fa-circle, .fa-check-circle');

                if (listItem.classList.contains('completed')) {
                    icon.classList.remove('fa-circle'); icon.classList.add('fa-check-circle'); icon.style.color = 'var(--success-color)';
                } else {
                    icon.classList.remove('fa-check-circle'); icon.classList.add('fa-circle'); icon.style.color = 'var(--primary-color)';
                }
                
                if (dateSpan) {
                    const fullDueTime = listItem.dataset.fullDueTime; 
                    if (fullDueTime) {
                        const dueDate = new Date(fullDueTime);
                        
                        if (listItem.classList.contains('completed')) {
                            dateSpan.classList.remove('expired');
                            dateSpan.innerHTML = `<i class="far fa-calendar-alt"></i> ${formatDateDisplay(fullDueTime, true)}`;
                        } 
                        else if (dueDate < now) { 
                            dateSpan.classList.add('expired');
                            dateSpan.innerHTML = `<i class="far fa-calendar-alt"></i> ${formatDateDisplay(fullDueTime, true)} (å·²è¿‡æœŸ)`; 
                        } else {
                            dateSpan.classList.remove('expired');
                            dateSpan.innerHTML = `<i class="far fa-calendar-alt"></i> ${formatDateDisplay(fullDueTime, true)}`;
                        }
                    }
                }
            });
        }
        
        // æ ¼å¼åŒ–å‡½æ•°ï¼šæ—¥æœŸ+æ—¶é—´ (V9 é€»è¾‘)
        function formatDateDisplay(isoString, includeTime = false) {
            const date = new Date(isoString);
            let result = `${date.getMonth() + 1}æœˆ${date.getDate()}æ—¥`;
            if (includeTime) {
                result += ` ${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
            }
            return result;
        }

        function sortTasks() {
            const sortBy = sortSelector.value;
            const tasks = Array.from(taskList.children);

            tasks.sort((a, b) => {
                const aCompleted = a.classList.contains('completed');
                const bCompleted = b.classList.contains('completed');

                if (aCompleted !== bCompleted) return aCompleted ? 1 : -1;

                switch (sortBy) {
                    case 'creation_desc': return new Date(b.dataset.creationTime) - new Date(a.dataset.creationTime);
                    case 'creation_asc': return new Date(a.dataset.creationTime) - new Date(b.dataset.creationTime);
                    case 'due_asc':
                        const aDueAsc = a.dataset.fullDueTime ? new Date(a.dataset.fullDueTime) : new Date('3000-01-01');
                        const bDueAsc = b.dataset.fullDueTime ? new Date(b.dataset.fullDueTime) : new Date('3000-01-01');
                        return aDueAsc - bDueAsc;
                    case 'due_desc':
                        const aDueDesc = a.dataset.fullDueTime ? new Date(a.dataset.fullDueTime) : new Date('1970-01-01');
                        const bDueDesc = b.dataset.fullDueTime ? new Date(b.dataset.fullDueTime) : new Date('1970-01-01');
                        return bDueDesc - aDueDesc;
                    case 'priority_desc':
                        const prioOrder = { 'High': 3, 'Medium': 2, 'Low': 1 };
                        return prioOrder[b.dataset.priority] - prioOrder[a.dataset.priority];
                    default: return 0;
                }
            });

            tasks.forEach(task => taskList.appendChild(task));
            saveTasks();
        }

        function applyFilter() {
            const tasks = taskList.querySelectorAll('li');
            const searchTerm = searchBar.value.toLowerCase().trim();

            tasks.forEach(task => {
                const isCompleted = task.classList.contains('completed');
                const taskText = task.textContent.toLowerCase();
                const taskTag = task.querySelector('.task-tags')?.textContent.toLowerCase() || '';

                let shouldShow = true;

                if (currentFilter === 'pending' && isCompleted) shouldShow = false;
                else if (currentFilter === 'completed' && !isCompleted) shouldShow = false;
                
                if (shouldShow && searchTerm !== '') {
                    if (!taskText.includes(searchTerm) && !taskTag.includes(searchTerm)) { shouldShow = false; }
                }
                
                task.style.display = shouldShow ? 'flex' : 'none';
            });
            updateTaskCount();
        }

        function clearCompletedTasks() {
            if (confirm('ç¡®å®šè¦æ°¸ä¹…æ¸…é™¤æ‰€æœ‰å·²å®Œæˆçš„ä»»åŠ¡å—ï¼Ÿ')) {
                taskList.querySelectorAll('li.completed').forEach(task => task.remove());
                saveTasks(); updateTaskCount();
            }
        }

        // --- 5. æŒä¹…åŒ–å’Œç»Ÿè®¡ (V9/V8 é€»è¾‘) ---

        function saveTasks() {
            const storedUser = JSON.parse(localStorage.getItem('todoUser'));
            if (!storedUser) return;
            storedUser.tasks = taskList.innerHTML; 
            localStorage.setItem('todoUser', JSON.stringify(storedUser));
        }

        function loadTasks() {
            const storedUser = JSON.parse(localStorage.getItem('todoUser'));
            if (!storedUser || storedUser.username !== currentUserName) return;

            taskList.innerHTML = storedUser.tasks || ''; 
            document.getElementById('userDisplay').textContent = `Hi, ${currentUserName}!`;
            checkDueDates();
            updateTaskCount();
            sortTasks();
            applyFilter();
        }
        
        function updateTaskCount() {
            const pendingTasks = Array.from(taskList.querySelectorAll('li:not(.completed)')).filter(li => li.style.display !== 'none').length;
            document.getElementById('pendingTaskCount').textContent = `å½“å‰å¾…åŠï¼š${pendingTasks} ä¸ª`;
        }

        function updateDashboardStats() {
            const tasks = taskList.querySelectorAll('li');
            const total = tasks.length;
            const completed = taskList.querySelectorAll('li.completed').length;
            const pending = total - completed;
            
            const highPrio = taskList.querySelectorAll('li[data-priority="High"]:not(.completed)').length;
            const lowPrio = taskList.querySelectorAll('li[data-priority="Low"]:not(.completed)').length;
            const mediumPrio = pending - highPrio - lowPrio;

            document.getElementById('totalTasksCount').textContent = total;
            
            const rate = total > 0 ? ((completed / total) * 100).toFixed(1) : 0;
            document.getElementById('completionRate').textContent = `${rate}%`;
            
            document.getElementById('highPrioCount').textContent = highPrio;
            document.getElementById('lowPrioCount').textContent = lowPrio;

            document.getElementById('prio-chart-description').innerHTML = `
                <p>æ€»å¾…åŠä»»åŠ¡æ•°ï¼š <strong>${pending}</strong> ä¸ª</p>
                <ul>
                    <li style="color:var(--prio-high);">é«˜ä¼˜å…ˆçº§ï¼š <strong>${highPrio}</strong> ä¸ª</li>
                    <li style="color:var(--prio-medium);">ä¸­ä¼˜å…ˆçº§ï¼š <strong>${mediumPrio}</strong> ä¸ª</li>
                    <li style="color:var(--prio-low);">ä½ä¼˜å…ˆçº§ï¼š <strong>${lowPrio}</strong> ä¸ª</li>
                </ul>
            `;
        }

        // --- 6. è®¾ç½®ä¸åª’ä½“åŠŸèƒ½ (V8 é€»è¾‘) ---

        function handleMusicUpload(e) {
            const file = e.target.files[0];
            musicError.style.display = 'none';
            audioPlayer.src = '';

            if (file && file.type.startsWith('audio/')) { 
                try {
                    const fileURL = URL.createObjectURL(file);
                    audioPlayer.src = fileURL;
                    audioPlayer.play();
                } catch (error) {
                    musicError.textContent = "*æç¤ºï¼šæ— æ³•æ’­æ”¾ï¼Œå¯èƒ½æ˜¯æµè§ˆå™¨å®‰å…¨é™åˆ¶ã€‚";
                    musicError.style.display = 'block';
                }
            } else if (file) {
                 musicError.textContent = "*æç¤ºï¼šè¯·é€‰æ‹©ä¸€ä¸ªæœ‰æ•ˆçš„éŸ³é¢‘æ–‡ä»¶ã€‚";
                 musicError.style.display = 'block';
            }
        }
        
        function applyTheme() {
            const newColor = themeSelector.value;
            document.documentElement.style.setProperty('--primary-color', newColor);
            
            let primaryDark;
            if (newColor === '#1abc9c') primaryDark = '#16a085';
            else if (newColor === '#3f51b5') primaryDark = '#303f9f';
            else if (newColor === '#e67e22') primaryDark = '#d35400';
            document.documentElement.style.setProperty('--primary-dark', primaryDark);
            
            localStorage.setItem('appThemeColor', newColor);
            localStorage.setItem('appThemeDark', primaryDark);
        }
        
        function loadTheme() {
            const savedColor = localStorage.getItem('appThemeColor');
            const savedDark = localStorage.getItem('appThemeDark');
            if (savedColor && savedDark) {
                document.documentElement.style.setProperty('--primary-color', savedColor);
                document.documentElement.style.setProperty('--primary-dark', savedDark);
                themeSelector.value = savedColor;
            }
        }

        function exportTasks() {
            const storedUser = JSON.parse(localStorage.getItem('todoUser'));
            if (!storedUser || !storedUser.tasks) { alert("æ²¡æœ‰ä»»åŠ¡æ•°æ®å¯ä»¥å¯¼å‡ºï¼"); return; }

            const taskData = {
                username: currentUserName, timestamp: new Date().toISOString(), tasksHTML: storedUser.tasks
            };
            
            const dataStr = JSON.stringify(taskData, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);
            const exportFileDefaultName = `${currentUserName}_tasks_backup.json`;

            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click(); 

            alert("ä»»åŠ¡å·²æˆåŠŸå¯¼å‡ºä¸º JSON æ–‡ä»¶ï¼");
        }

        function importTasks(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(event) {
                try {
                    const importedData = JSON.parse(event.target.result);
                    
                    if (!importedData.tasksHTML || !importedData.username) {
                        alert("å¯¼å…¥å¤±è´¥ï¼šJSON æ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®ã€‚");
                        return;
                    }
                    
                    if (confirm(`ç¡®å®šè¦å¯¼å…¥ç”¨æˆ· "${importedData.username}" çš„ä»»åŠ¡ï¼Œå¹¶è¦†ç›–å½“å‰åˆ—è¡¨å—ï¼Ÿ`)) {
                        const storedUser = JSON.parse(localStorage.getItem('todoUser'));
                        storedUser.tasks = importedData.tasksHTML;
                        localStorage.setItem('todoUser', JSON.stringify(storedUser));

                        loadTasks(); 
                        alert("ä»»åŠ¡å¯¼å…¥æˆåŠŸï¼è¯·æ£€æŸ¥ä»»åŠ¡ä¸­å¿ƒã€‚");
                    }
                } catch (error) {
                    alert("å¯¼å…¥å¤±è´¥ï¼šæ–‡ä»¶å†…å®¹ä¸æ˜¯æœ‰æ•ˆçš„ JSON æ ¼å¼ã€‚");
                }
            };
            reader.readAsText(file);
        }
    </script>
</body>
</html>
